<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test XP Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test XP Fix</h1>
    <p>Kiểm tra XP được cập nhật đúng sau khi hoàn thành game</p>
    <p id="loading">Loading modules...</p>

    <button id="btnSession">Check Session</button>
    <button id="btnXPUpdate">Test XP Update (Client-side)</button>
    <button id="btnGameCompletion">Test Game Completion Flow</button>
    <button id="btnCheckProfile">Check Current Profile</button>

    <div id="results"></div>

    <script type="module">
        // Dynamic import to avoid MIME type issues
        async function loadModules() {
            try {
                const supabaseModule = await import('./js/supabase/supabase.js');
                const authModule = await import('./js/supabase/auth.js');
                const userProfileModule = await import('./js/modules/user_profile.js');
                const rewardsModule = await import('./js/modules/rewards.js');

                // Expose to global scope
                window.supabase = supabaseModule.supabase;
                window.userProfile = userProfileModule.userProfile;
                window.rewards = rewardsModule.rewards;

                console.log('✅ Modules loaded successfully');
                setupEventListeners();

                // Hide loading message
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.style.display = 'none';

            } catch (error) {
                console.error('❌ Failed to load modules:', error);
                document.getElementById('results').innerHTML = '<div class="result error">❌ Failed to load modules: ' + error.message + '</div>';
            }
        }

        // Start loading modules
        loadModules();

        function setupEventListeners() {

        window.testClientXPUpdate = async function() {
            try {
                const result = document.getElementById('results');
                result.innerHTML += '<div class="result">Testing client-side XP update...</div>';

                const user = await userProfile.getCurrentUser();
                if (!user) {
                    result.innerHTML += '<div class="result error">❌ Not logged in</div>';
                    return;
                }

                const profileBefore = await userProfile.getProfile();
                result.innerHTML += '<div class="result">Profile before: ' + JSON.stringify({
                    level: profileBefore.level,
                    xp: profileBefore.xp,
                    coins: profileBefore.coins
                }, null, 2) + '</div>';

                // Test client-side XP update
                const addXPResult = await userProfile.addXP(25);
                if (addXPResult) {
                    result.innerHTML += '<div class="result success">✅ Client-side XP update successful</div>';
                    result.innerHTML += '<div class="result">Result: <pre>' + JSON.stringify(addXPResult, null, 2) + '</pre></div>';

                    // Check profile after (force refresh to bypass cache)
                    const profileAfter = await userProfile.getProfile(true); // forceRefresh = true
                    result.innerHTML += '<div class="result">Profile after: ' + JSON.stringify({
                        level: profileAfter.level,
                        xp: profileAfter.xp,
                        coins: profileAfter.coins
                    }, null, 2) + '</div>';

                    const xpIncrease = profileAfter.xp - profileBefore.xp;
                    result.innerHTML += '<div class="result">XP increased by: ' + xpIncrease + '</div>';

                    if (xpIncrease === 0) {
                        result.innerHTML += '<div class="result error">⚠️ XP did not increase! Check database update.</div>';
                    }
                } else {
                    result.innerHTML += '<div class="result error">❌ Client-side XP update failed</div>';
                }

            } catch (error) {
                document.getElementById('results').innerHTML += '<div class="result error">❌ Error: ' + error.message + '</div>';
            }
        };

        // Expose test functions to global scope
        window.testSession = async function() {
            try {
                const result = document.getElementById('results');
                result.innerHTML += '<div class="result">Checking session...</div>';

                const { data: { session } } = await supabase.auth.getSession();
                result.innerHTML += '<div class="result">Session exists: ' + !!session + '</div>';

                if (session) {
                    result.innerHTML += '<div class="result">Access token exists: ' + !!session.access_token + '</div>';
                    result.innerHTML += '<div class="result">User ID: ' + session.user?.id + '</div>';
                } else {
                    result.innerHTML += '<div class="result error">❌ No valid session found</div>';
                }
            } catch (error) {
                document.getElementById('results').innerHTML += '<div class="result error">❌ Error checking session: ' + error.message + '</div>';
            }
        };

        window.testXPUpdate = async function() {
            try {
                const result = document.getElementById('results');
                result.innerHTML += '<div class="result">Testing XP update...</div>';

                const user = await userProfile.getCurrentUser();
                if (!user) {
                    result.innerHTML += '<div class="result error">❌ Not logged in</div>';
                    return;
                }

                const profileBefore = await userProfile.getProfile();
                result.innerHTML += '<div class="result">Profile before: ' + JSON.stringify({
                    level: profileBefore.level,
                    xp: profileBefore.xp,
                    coins: profileBefore.coins
                }, null, 2) + '</div>';

                // Test direct edge function call
                const { data: { session } } = await supabase.auth.getSession();
                if (!session || !session.access_token) {
                    throw new Error('Không tìm thấy session hợp lệ');
                }

                const accessToken = session.access_token;

                const response = await fetch('https://calwzopyjitbtahiafzw.supabase.co/functions/v1/addXP', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                    },
                    body: JSON.stringify({
                        amount: 25,
                        reason: 'test_game_completion'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();

                if (data.success) {
                    result.innerHTML += '<div class="result success">✅ XP added successfully via Edge Function</div>';
                    result.innerHTML += '<div class="result">Response: <pre>' + JSON.stringify(data, null, 2) + '</pre></div>';

                    // Handle level up rewards from response
                    if (data.data.rewards && (data.data.rewards.coins > 0 || data.data.rewards.gems > 0)) {
                        result.innerHTML += '<div class="result">Level up rewards: ' + data.data.rewards.coins + ' coins, ' + data.data.rewards.gems + ' gems</div>';
                        if (data.data.rewards.coins > 0) {
                            await userProfile.addCoins(data.data.rewards.coins);
                        }
                        if (data.data.rewards.gems > 0) {
                            await userProfile.addGems(data.data.rewards.gems);
                        }
                    }

                    // Check profile after
                    const profileAfter = await userProfile.getProfile();
                    result.innerHTML += '<div class="result">Profile after: ' + JSON.stringify({
                        level: profileAfter.level,
                        xp: profileAfter.xp,
                        coins: profileAfter.coins,
                        gems: profileAfter.gems
                    }, null, 2) + '</div>';
                } else {
                    throw new Error(data.error);
                }

            } catch (error) {
                document.getElementById('results').innerHTML += '<div class="result error">❌ Error: ' + error.message + '</div>';
            }
        };

        window.testGameCompletion = async function() {
            try {
                const result = document.getElementById('results');
                result.innerHTML += '<div class="result">Testing game completion flow...</div>';

                const profileBefore = await userProfile.getProfile();
                result.innerHTML += '<div class="result">Profile before: ' + JSON.stringify({
                    level: profileBefore.level,
                    xp: profileBefore.xp,
                    coins: profileBefore.coins
                }, null, 2) + '</div>';

                // Test game completion (with fallback mechanism)
                const gameResult = await rewards.grantGameRewards('easy', 300, false); // easy, fast completion, no streak

                if (gameResult.success) {
                    result.innerHTML += '<div class="result success">✅ Game completion successful</div>';
                    result.innerHTML += '<div class="result">Rewards: <pre>' + JSON.stringify(gameResult, null, 2) + '</pre></div>';

                    // Check profile after
                    const profileAfter = await userProfile.getProfile();
                    result.innerHTML += '<div class="result">Profile after: ' + JSON.stringify({
                        level: profileAfter.level,
                        xp: profileAfter.xp,
                        coins: profileAfter.coins
                    }, null, 2) + '</div>';

                    // Check if XP actually increased
                    const xpIncrease = profileAfter.xp - profileBefore.xp;
                    const coinsIncrease = profileAfter.coins - profileBefore.coins;
                    result.innerHTML += '<div class="result">XP increased: ' + xpIncrease + ', Coins increased: ' + coinsIncrease + '</div>';
                } else {
                    result.innerHTML += '<div class="result error">❌ Game completion failed: ' + gameResult.message + '</div>';
                }

            } catch (error) {
                result.innerHTML += '<div class="result error">❌ Error: ' + error.message + '</div>';
            }
        };

        window.checkProfile = async function() {
            try {
                const profile = await userProfile.getProfile(true); // forceRefresh = true
                document.getElementById('results').innerHTML += '<div class="result">Current Profile: <pre>' + JSON.stringify(profile, null, 2) + '</pre></div>';
            } catch (error) {
                document.getElementById('results').innerHTML += '<div class="result error">❌ Error: ' + error.message + '</div>';
            }
        };
    </script>
</body>
</html>
