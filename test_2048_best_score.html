<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test 2048 Best Score Display</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .result { margin: 10px 0; padding: 10px; background: #f9f9f9; }
        .error { background: #ffe6e6; color: #cc0000; }
        .success { background: #e6ffe6; color: #009900; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .best-score-display { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <h1>Test 2048 Best Score Display</h1>

    <div class="test-section">
        <h3>1. Test Best Score Display Element</h3>
        <div id="best-score-display" class="best-score-display">Best: --</div>
        <button onclick="testElementBinding()">Test Element Binding</button>
        <div id="element-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. Test Database Query</h3>
        <button onclick="testDatabaseQuery()">Test Database Query</button>
        <div id="db-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. Test Full Update Function</h3>
        <button onclick="testUpdateFunction()">Test Update Function</button>
        <div id="update-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. Test Game Config Loading</h3>
        <button onclick="testGameConfig()">Test Game Config</button>
        <div id="config-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>5. Manual Test - Simulate 2048 Game</h3>
        <button onclick="simulateGameResult()">Simulate Game Result</button>
        <div id="simulate-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>6. Test Realtime UI Updates</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="number" id="test-score" placeholder="Score (e.g. 5000)" value="5000">
            <button onclick="testRealtimeUpdate()">Test Realtime Update</button>
        </div>
        <div id="realtime-result" class="result"></div>
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
            Note: This simulates the UI update that happens after game submission.
            Check if Best Score and Rank update without page refresh.
        </div>
    </div>

    <script type="module">
        import { supabase } from './public/js/supabase/supabase.js';

        // Test element binding
        window.testElementBinding = function() {
            const element = document.getElementById('best-score-display');
            const resultDiv = document.getElementById('element-result');

            if (element) {
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Element found: ${element.tagName}#${element.id} with content: "${element.textContent}"`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Element not found!';
            }
        };

        // Test database query directly
        window.testDatabaseQuery = async function() {
            const resultDiv = document.getElementById('db-result');

            try {
                // Get current user
                const { data: userData, error: userError } = await supabase.auth.getUser();
                if (userError || !userData.user) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå User not logged in';
                    return;
                }

                // Get game config
                const { data: gameData, error: gameError } = await supabase
                    .from('games')
                    .select('id')
                    .eq('code', '2048')
                    .maybeSingle();

                if (gameError || !gameData) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå Game not found: ' + (gameError?.message || 'No data');
                    return;
                }

                const { data: modeData, error: modeError } = await supabase
                    .from('game_modes')
                    .select('id')
                    .eq('game_id', gameData.id)
                    .eq('code', 'classic')
                    .maybeSingle();

                if (modeError || !modeData) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå Game mode not found: ' + (modeError?.message || 'No data');
                    return;
                }

                // Query best score
                const { data: bestScore, error: scoreError } = await supabase
                    .from('game_best_scores')
                    .select('metric_value, better_is, updated_at')
                    .eq('user_id', userData.user.id)
                    .eq('game_id', gameData.id)
                    .eq('mode_id', modeData.id)
                    .maybeSingle();

                if (scoreError) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Query error: ${scoreError.message}`;
                    return;
                }

                if (bestScore) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ Best score found:<br>
                        - Value: ${bestScore.metric_value}<br>
                        - Better is: ${bestScore.better_is}<br>
                        - Updated: ${new Date(bestScore.updated_at).toLocaleString()}
                    `;
                } else {
                    resultDiv.className = 'result';
                    resultDiv.textContent = '‚ÑπÔ∏è No best score found in database (this is normal for new users)';
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Unexpected error: ${error.message}`;
            }
        };

        // Test the actual update function from 2048.js
        window.testUpdateFunction = async function() {
            const resultDiv = document.getElementById('update-result');

            try {
                // Import the Game2048 class
                const { Game2048 } = await import('./public/js/modules/2048.js');

                // Create instance
                const game = new Game2048('test-grid', 4);

                // Wait for DOM to be ready
                await new Promise(resolve => setTimeout(resolve, 100));

                // Call updateBestScoreDisplay
                await game.updateBestScoreDisplay();

                const element = document.getElementById('best-score-display');
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Update function called. Display shows: "${element.textContent}"`;

                // Clean up
                if (game.destroy) game.destroy();

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Update function error: ${error.message}`;
            }
        };

        // Test game config loading
        window.testGameConfig = async function() {
            const resultDiv = document.getElementById('config-result');

            try {
                // Get game ID
                const { data: gameData, error: gameError } = await supabase
                    .from('games')
                    .select('id, code, name')
                    .eq('code', '2048')
                    .maybeSingle();

                if (gameError || !gameData) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå Game lookup failed: ' + (gameError?.message || 'No data');
                    return;
                }

                // Get mode ID
                const { data: modeData, error: modeError } = await supabase
                    .from('game_modes')
                    .select('id, code, name')
                    .eq('game_id', gameData.id)
                    .eq('code', 'classic')
                    .maybeSingle();

                if (modeError || !modeData) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå Mode lookup failed: ' + (modeError?.message || 'No data');
                    return;
                }

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    ‚úÖ Game config loaded:<br>
                    - Game: ${gameData.name} (${gameData.code}) - ID: ${gameData.id}<br>
                    - Mode: ${modeData.name} (${modeData.code}) - ID: ${modeData.id}
                `;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Config loading error: ${error.message}`;
            }
        };

        // Simulate submitting a game result
        window.simulateGameResult = async function() {
            const resultDiv = document.getElementById('simulate-result');

            try {
                const { data: userData, error: userError } = await supabase.auth.getUser();
                if (userError || !userData.user) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå User not logged in';
                    return;
                }

                // Submit a fake game result
                const submitResult = await supabase.functions.invoke('submitGameResult', {
                    body: {
                        game_code: '2048',
                        mode_code: 'classic',
                        metric_type: 'score',
                        metric_value: Math.floor(Math.random() * 10000) + 5000, // Random score 5000-15000
                        extra_data: {
                            maxTile: 512,
                            moves: 50,
                            gameOver: true
                        }
                    }
                });

                if (submitResult.error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Submit failed: ${submitResult.error.message}`;
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ Game result submitted successfully!<br>
                        This should trigger the best score update.<br>
                        <button onclick="testDatabaseQuery()">Check if best score updated</button>
                    `;
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Simulation error: ${error.message}`;
            }
        };

        // Test realtime UI updates
        window.testRealtimeUpdate = async function() {
            const resultDiv = document.getElementById('realtime-result');
            const scoreInput = document.getElementById('test-score');
            const testScore = parseInt(scoreInput.value) || 5000;

            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div>‚è≥ Testing realtime UI update...</div>';

            try {
                // First, submit a fake game result to update database
                const { data: userData, error: userError } = await supabase.auth.getUser();
                if (userError || !userData.user) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå User not logged in for realtime test';
                    return;
                }

                // Submit test result
                const submitResult = await supabase.functions.invoke('submitGameResult', {
                    body: {
                        game_code: '2048',
                        mode_code: 'classic',
                        metric_type: 'score',
                        metric_value: testScore,
                        extra_data: {
                            maxTile: 256,
                            moves: 100,
                            gameOver: true
                        }
                    }
                });

                if (submitResult.error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Submit failed: ${submitResult.error.message}`;
                    return;
                }

                // Wait a moment for database update
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Test UI updates (simulate what happens in handleGameOver)
                const bestScoreElement = document.getElementById('best-score-display');
                const initialBestScore = bestScoreElement.textContent;

                // Simulate realtime update calls
                try {
                    // Load Game2048 class to test update methods
                    const { Game2048 } = await import('./public/js/modules/2048.js');
                    const game = new Game2048('test-grid-2', 4);

                    // Call update methods
                    await game.updateBestScoreDisplay();
                    await game.updateRankDisplay();

                    // Clean up
                    if (game.destroy) game.destroy();

                    const finalBestScore = bestScoreElement.textContent;

                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ Realtime UI update test completed!<br>
                        - Submitted score: ${testScore}<br>
                        - Initial display: "${initialBestScore}"<br>
                        - Final display: "${finalBestScore}"<br>
                        <strong>${initialBestScore !== finalBestScore ? 'üéâ UI UPDATED SUCCESSFULLY!' : '‚ÑπÔ∏è No change (score may not be better)'}</strong>
                    `;

                } catch (uiError) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå UI update test failed: ${uiError.message}`;
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Realtime test error: ${error.message}`;
            }
        };

        // Run initial test
        setTimeout(() => {
            testElementBinding();
        }, 100);
    </script>
</body>
</html>
