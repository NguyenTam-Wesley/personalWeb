<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Buff System - Items & Pets</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .section h2 {
            margin: 0 0 20px 0;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .item-card, .pet-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
            position: relative;
        }

        .item-card:hover, .pet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .item-name, .pet-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #495057;
        }

        .item-description, .pet-description {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .item-stats, .pet-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat-badge {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            color: #495057;
        }

        .rarity-common { background: #6c757d; color: white; }
        .rarity-rare { background: #007bff; color: white; }
        .rarity-epic { background: #6f42c1; color: white; }
        .rarity-legendary { background: #fd7e14; color: white; }

        .item-actions, .pet-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .owned-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .active-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #212529;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .quantity-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #17a2b8;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
        }

        /* Buff Panel */
        .buff-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #dee2e6;
            position: sticky;
            top: 20px;
        }

        .buff-title {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #495057;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .buff-section {
            margin-bottom: 25px;
        }

        .buff-section-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .buff-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-bottom: 8px;
            border: 1px solid #dee2e6;
        }

        .buff-info {
            flex: 1;
        }

        .buff-name {
            font-weight: bold;
            color: #495057;
        }

        .buff-details {
            font-size: 0.9em;
            color: #6c757d;
        }

        .buff-value {
            font-weight: bold;
            font-size: 1.1em;
            color: #28a745;
        }

        .buff-expiry {
            font-size: 0.8em;
            color: #dc3545;
            margin-top: 2px;
        }

        .no-buffs {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .refresh-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #495057;
            font-weight: bold;
        }

        .auto-refresh-toggle input {
            width: auto;
        }

        .logs-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .logs-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
        }

        .logs-container {
            background: #343a40;
            color: #f8f9fa;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-time {
            color: #6c757d;
        }

        .log-level-info { color: #17a2b8; }
        .log-level-success { color: #28a745; }
        .log-level-error { color: #dc3545; }
        .log-level-buff { color: #ffc107; font-weight: bold; }
        .log-level-pet { color: #e83e8c; font-weight: bold; }

        .status-panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
        }

        .status-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .status-label {
            color: #6c757d;
        }

        .status-value {
            font-weight: bold;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            background: #e9ecef;
            border-radius: 5px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Test Buff System</h1>
            <p>Test h·ªá th·ªëng items v√† pets, hi·ªÉn th·ªã real-time buff effects</p>
        </div>

        <div class="main-content">
            <!-- Items & Pets Section -->
            <div class="section">
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchTab('items')">üéí Items</button>
                        <button class="tab-btn" onclick="switchTab('pets')">üêæ Pets</button>
                        <button class="tab-btn" onclick="switchTab('shop')">üõí Shop</button>
                    </div>
                </div>

                <!-- Items Tab -->
                <div id="items-tab" class="tab-content active">
                    <h2>üéí Inventory Items</h2>
                    <div class="refresh-controls">
                        <button class="btn-secondary" onclick="refreshItems()">
                            üîÑ Refresh Items
                        </button>
                        <div class="auto-refresh-toggle">
                            <input type="checkbox" id="auto-refresh" checked onchange="toggleAutoRefresh()">
                            <label for="auto-refresh">Auto Refresh</label>
                        </div>
                    </div>
                    <div id="items-container" class="grid-container">
                        <div class="item-card">
                            <div class="loading"></div>
                            <div>Loading items...</div>
                        </div>
                    </div>
                </div>

                <!-- Pets Tab -->
                <div id="pets-tab" class="tab-content">
                    <h2>üêæ My Pets</h2>
                    <div class="refresh-controls">
                        <button class="btn-secondary" onclick="refreshPets()">
                            üîÑ Refresh Pets
                        </button>
                    </div>
                    <div id="pets-container" class="grid-container">
                        <div class="pet-card">
                            <div class="loading"></div>
                            <div>Loading pets...</div>
                        </div>
                    </div>
                </div>

                <!-- Shop Tab -->
                <div id="shop-tab" class="tab-content">
                    <h2>üõí Shop</h2>
                    <div class="grid-container">
                        <div class="item-card">
                            <div class="loading"></div>
                            <div>Loading shop...</div>
                        </div>
                    </div>
                </div>

                <!-- Status Panel -->
                <div class="status-panel">
                    <div class="status-title">üìä Account Status</div>
                    <div class="status-item">
                        <span class="status-label">Coins:</span>
                        <span class="status-value" id="coins-display">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Gems:</span>
                        <span class="status-value" id="gems-display">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Level:</span>
                        <span class="status-value" id="level-display">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">XP:</span>
                        <span class="status-value" id="xp-display">--</span>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="refreshProfile()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                            üîÑ Refresh Profile
                        </button>
                    </div>
                </div>
            </div>

            <!-- Buff Panel -->
            <div class="buff-panel">
                <div class="buff-title">‚ö° Active Buffs</div>

                <div class="buff-section">
                    <div class="buff-section-title">üéØ Item Effects</div>
                    <div id="item-effects">
                        <div class="no-buffs">No active item effects</div>
                    </div>
                </div>

                <div class="buff-section">
                    <div class="buff-section-title">üêæ Pet Bonuses</div>
                    <div id="pet-bonuses">
                        <div class="no-buffs">No active pet</div>
                    </div>
                </div>

                <div class="buff-section">
                    <div class="buff-section-title">üìà Total Multipliers</div>
                    <div id="total-multipliers">
                        <div class="buff-item">
                            <div class="buff-info">
                                <div class="buff-name">XP Multiplier</div>
                                <div class="buff-details">Total XP boost from all sources</div>
                            </div>
                            <div class="buff-value" id="xp-multiplier">1.00x</div>
                        </div>
                        <div class="buff-item">
                            <div class="buff-info">
                                <div class="buff-name">Coin Multiplier</div>
                                <div class="buff-details">Total coin boost from all sources</div>
                            </div>
                            <div class="buff-value" id="coin-multiplier">1.00x</div>
                        </div>
                        <div class="buff-item">
                            <div class="buff-info">
                                <div class="buff-name">Luck Multiplier</div>
                                <div class="buff-details">Total luck boost from all sources</div>
                            </div>
                            <div class="buff-value" id="luck-multiplier">1.00x</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="logs-section">
            <div class="logs-title">üìã Activity Logs</div>
            <div class="logs-container" id="logs-container">
                <div class="log-entry">
                    <span class="log-time">[00:00:00]</span>
                    <span class="log-level-info">Buff system test initialized</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { supabase } from '../public/js/supabase/supabase.js';
        import { items } from '../public/js/modules/items.js';
        import { pets } from '../public/js/modules/pets.js';
        import { userProfile } from '../public/js/modules/user_profile.js';

        // Global state
        let currentUser = null;
        let autoRefreshEnabled = true;
        let autoRefreshInterval = null;
        let currentTab = 'items';

        // Initialize
        async function init() {
            log('info', 'Initializing buff system test...');

            try {
                // Check authentication
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error || !user) {
                    log('error', 'User not authenticated. Please login first.');
                    alert('Please login first to test the buff system!');
                    return;
                }

                currentUser = user;
                log('success', `Authenticated as: ${user.email}`);

                // Load initial data
                await refreshProfile();
                await refreshItems();
                await refreshPets();
                await refreshBuffs();

                // Start auto refresh
                startAutoRefresh();

            } catch (error) {
                log('error', `Initialization failed: ${error.message}`);
                console.error('Init error:', error);
            }
        }

        // Switch tabs
        window.switchTab = function(tabName) {
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');

            // Refresh data for the tab
            if (tabName === 'items') {
                refreshItems();
            } else if (tabName === 'pets') {
                refreshPets();
            } else if (tabName === 'shop') {
                loadShop();
            }
        };

        // Refresh items
        window.refreshItems = async function() {
            const container = document.getElementById('items-container');
            container.innerHTML = '<div class="item-card"><div class="loading"></div><div>Loading items...</div></div>';

            try {
                const inventory = await items.getUserInventory(true);
                const allItems = await items.getAllItems(true);

                if (Object.keys(inventory).length === 0) {
                    container.innerHTML = '<div class="item-card"><div style="text-align: center; padding: 40px; color: #6c757d;">No items in inventory</div></div>';
                    return;
                }

                container.innerHTML = Object.values(inventory).map(itemData => {
                    const item = itemData.item;
                    const quantity = itemData.quantity;
                    const canUse = item.type === 'consumable';

                    return `
                        <div class="item-card">
                            <div class="quantity-badge">${quantity}x</div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-description">${item.description}</div>
                            <div class="item-stats">
                                <span class="stat-badge rarity-${item.rarity}">${item.rarity}</span>
                                <span class="stat-badge">${item.type}</span>
                            </div>
                            <div class="item-actions">
                                ${canUse ? `<button class="btn-success" onclick="useItem('${item.id}')">Use Item</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                log('info', `Loaded ${Object.keys(inventory).length} items`);

            } catch (error) {
                log('error', `Failed to load items: ${error.message}`);
                container.innerHTML = '<div class="item-card"><div style="text-align: center; padding: 40px; color: #dc3545;">Error loading items</div></div>';
            }
        };

        // Refresh pets
        window.refreshPets = async function() {
            const container = document.getElementById('pets-container');
            container.innerHTML = '<div class="pet-card"><div class="loading"></div><div>Loading pets...</div></div>';

            try {
                const userPets = await pets.getUserPets(true);
                const activePet = await pets.getActivePet();

                if (userPets.length === 0) {
                    container.innerHTML = '<div class="pet-card"><div style="text-align: center; padding: 40px; color: #6c757d;">No pets owned</div></div>';
                    return;
                }

                container.innerHTML = userPets.map(petData => {
                    const pet = petData.pets;
                    const isActive = petData.is_active;
                    const happiness = petData.happiness_level;
                    const lastFed = petData.last_fed_at ? new Date(petData.last_fed_at).toLocaleString() : 'Never';

                    return `
                        <div class="pet-card">
                            ${isActive ? '<div class="active-indicator">ACTIVE</div>' : '<div class="owned-indicator">OWNED</div>'}
                            <div class="pet-name">${pet.name}</div>
                            <div class="pet-description">${pet.description}</div>
                            <div class="pet-stats">
                                <span class="stat-badge rarity-${pet.rarity}">${pet.rarity}</span>
                                <span class="stat-badge">‚ù§Ô∏è ${happiness}/100</span>
                                <span class="stat-badge">üéØ +${pet.happiness_boost}%</span>
                                <span class="stat-badge">üçÄ +${pet.luck_boost}%</span>
                            </div>
                            <div class="pet-actions">
                                ${!isActive ? `<button class="btn-primary" onclick="setActivePet('${pet.id}')">Set Active</button>` : ''}
                                <button class="btn-warning" onclick="feedPet('${pet.id}')">Feed Pet</button>
                            </div>
                            <div style="font-size: 0.8em; color: #6c757d; margin-top: 8px;">
                                Last fed: ${lastFed}
                            </div>
                        </div>
                    `;
                }).join('');

                log('info', `Loaded ${userPets.length} pets`);

            } catch (error) {
                log('error', `Failed to load pets: ${error.message}`);
                container.innerHTML = '<div class="pet-card"><div style="text-align: center; padding: 40px; color: #dc3545;">Error loading pets</div></div>';
            }
        };

        // Load shop
        async function loadShop() {
            const container = document.getElementById('shop-tab').querySelector('.grid-container');
            container.innerHTML = '<div class="item-card"><div class="loading"></div><div>Loading shop...</div></div>';

            try {
                const [allItems, allPets] = await Promise.all([
                    items.getAllItems(true),
                    pets.getAllPets(true)
                ]);

                const shopItems = [
                    ...allItems.map(item => ({ ...item, shopType: 'item' })),
                    ...allPets.map(pet => ({ ...pet, shopType: 'pet' }))
                ].filter(item => item.is_available);

                container.innerHTML = shopItems.map(shopItem => {
                    const isPet = shopItem.shopType === 'pet';
                    const price = isPet ? shopItem.price_gems : (shopItem.price_gems || shopItem.price_coins);
                    const currency = isPet || shopItem.price_gems ? 'üíé' : 'ü™ô';

                    return `
                        <div class="item-card">
                            <div class="item-name">${shopItem.name}</div>
                            <div class="item-description">${shopItem.description}</div>
                            <div class="item-stats">
                                <span class="stat-badge rarity-${shopItem.rarity}">${shopItem.rarity}</span>
                                ${isPet ? `
                                    <span class="stat-badge">üéØ +${shopItem.happiness_boost}%</span>
                                    <span class="stat-badge">üçÄ +${shopItem.luck_boost}%</span>
                                    <span class="stat-badge">Lv.${shopItem.unlock_level}+</span>
                                ` : `
                                    <span class="stat-badge">${shopItem.type}</span>
                                `}
                            </div>
                            <div class="item-actions">
                                <button class="btn-primary" onclick="buyItem('${shopItem.id}', '${shopItem.shopType}')">
                                    ${currency} ${price}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                log('info', `Loaded ${shopItems.length} shop items`);

            } catch (error) {
                log('error', `Failed to load shop: ${error.message}`);
                container.innerHTML = '<div class="item-card"><div style="text-align: center; padding: 40px; color: #dc3545;">Error loading shop</div></div>';
            }
        }

        // Use item
        window.useItem = async function(itemId) {
            try {
                log('info', `Using item ${itemId}...`);

                const result = await items.useItem(itemId, 1);
                if (result.success) {
                    log('buff', `‚úÖ ${result.message}`);
                    await refreshItems();
                    await refreshBuffs();
                    await refreshProfile();
                } else {
                    log('error', `‚ùå ${result.message}`);
                    alert(result.message);
                }
            } catch (error) {
                log('error', `Failed to use item: ${error.message}`);
            }
        };

        // Set active pet
        window.setActivePet = async function(petId) {
            try {
                log('pet', `Setting active pet ${petId}...`);

                const result = await pets.setActivePet(petId);
                if (result.success) {
                    log('pet', `‚úÖ ${result.message}`);
                    await refreshPets();
                    await refreshBuffs();
                } else {
                    log('error', `‚ùå ${result.message}`);
                    alert(result.message);
                }
            } catch (error) {
                log('error', `Failed to set active pet: ${error.message}`);
            }
        };

        // Feed pet
        window.feedPet = async function(petId) {
            try {
                log('pet', `Feeding pet ${petId}...`);

                const result = await pets.feedPet(petId);
                if (result.success) {
                    log('pet', `‚úÖ ${result.message}`);
                    await refreshPets();
                    await refreshBuffs();
                } else {
                    log('error', `‚ùå ${result.message}`);
                    alert(result.message);
                }
            } catch (error) {
                log('error', `Failed to feed pet: ${error.message}`);
            }
        };

        // Buy item
        window.buyItem = async function(itemId, shopType) {
            try {
                log('info', `Buying ${shopType} ${itemId}...`);

                let result;
                if (shopType === 'pet') {
                    result = await pets.buyPet(itemId);
                } else {
                    result = await items.buyItem(itemId);
                }

                if (result.success) {
                    log('success', `‚úÖ ${result.message}`);
                    await refreshProfile();
                    if (shopType === 'pet') {
                        await refreshPets();
                    } else {
                        await refreshItems();
                    }
                    await refreshBuffs();
                } else {
                    log('error', `‚ùå ${result.message}`);
                    alert(result.message);
                }
            } catch (error) {
                log('error', `Failed to buy ${shopType}: ${error.message}`);
            }
        };

        // Refresh buffs
        async function refreshBuffs() {
            try {
                // Get item effects
                const itemEffects = await items.getCurrentActiveEffects();

                const itemEffectsContainer = document.getElementById('item-effects');
                if (itemEffects.length === 0) {
                    itemEffectsContainer.innerHTML = '<div class="no-buffs">No active item effects</div>';
                } else {
                    itemEffectsContainer.innerHTML = itemEffects.map(effect => {
                        const expiry = new Date(effect.expires_at);
                        const timeLeft = Math.max(0, expiry - Date.now());
                        const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                        const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));

                        return `
                            <div class="buff-item">
                                <div class="buff-info">
                                    <div class="buff-name">${effect.effect_type.replace('_', ' ').toUpperCase()}</div>
                                    <div class="buff-details">${effect.value}% boost</div>
                                    <div class="buff-expiry">Expires in ${hoursLeft}h ${minutesLeft}m</div>
                                </div>
                                <div class="buff-value">+${effect.value}%</div>
                            </div>
                        `;
                    }).join('');
                }

                // Get pet bonuses
                const petBonuses = await pets.getCurrentPetBonuses();

                const petBonusesContainer = document.getElementById('pet-bonuses');
                if (!petBonuses.happiness_boost && !petBonuses.luck_boost) {
                    petBonusesContainer.innerHTML = '<div class="no-buffs">No active pet</div>';
                } else {
                    const activePet = await pets.getActivePet();
                    petBonusesContainer.innerHTML = `
                        <div class="buff-item">
                            <div class="buff-info">
                                <div class="buff-name">${activePet.pets.name}</div>
                                <div class="buff-details">Active pet bonuses</div>
                            </div>
                        </div>
                        <div class="buff-item">
                            <div class="buff-info">
                                <div class="buff-name">Happiness Boost</div>
                                <div class="buff-details">From active pet happiness</div>
                            </div>
                            <div class="buff-value">+${petBonuses.happiness_boost.toFixed(1)}%</div>
                        </div>
                        <div class="buff-item">
                            <div class="buff-info">
                                <div class="buff-name">Luck Boost</div>
                                <div class="buff-details">From active pet luck</div>
                            </div>
                            <div class="buff-value">+${petBonuses.luck_boost.toFixed(1)}%</div>
                        </div>
                    `;
                }

                // Calculate total multipliers
                let totalXpBoost = 0;
                let totalCoinBoost = 0;
                let totalLuckBoost = petBonuses.luck_boost;

                itemEffects.forEach(effect => {
                    if (effect.effect_type === 'xp_boost') {
                        totalXpBoost += effect.value;
                    } else if (effect.effect_type === 'coin_boost') {
                        totalCoinBoost += effect.value;
                    } else if (effect.effect_type === 'luck_boost') {
                        totalLuckBoost += effect.value;
                    }
                });

                document.getElementById('xp-multiplier').textContent = `${(1 + totalXpBoost / 100).toFixed(2)}x`;
                document.getElementById('coin-multiplier').textContent = `${(1 + totalCoinBoost / 100).toFixed(2)}x`;
                document.getElementById('luck-multiplier').textContent = `${(1 + totalLuckBoost / 100).toFixed(2)}x`;

                log('buff', `Buffs updated: XP +${totalXpBoost}%, Coin +${totalCoinBoost}%, Luck +${totalLuckBoost.toFixed(1)}%`);

            } catch (error) {
                log('error', `Failed to refresh buffs: ${error.message}`);
            }
        }

        // Refresh profile
        window.refreshProfile = async function() {
            try {
                const profile = await userProfile.getProfile();
                if (profile) {
                    document.getElementById('coins-display').textContent = (profile.coins || 0).toLocaleString();
                    document.getElementById('gems-display').textContent = (profile.gems || 0).toLocaleString();
                    document.getElementById('level-display').textContent = profile.level || 1;
                    document.getElementById('xp-display').textContent = `${(profile.xp || 0).toLocaleString()} / ${(profile.xp_for_next_level || 1000).toLocaleString()}`;
                }
            } catch (error) {
                log('error', `Failed to refresh profile: ${error.message}`);
            }
        };

        // Toggle auto refresh
        window.toggleAutoRefresh = function() {
            autoRefreshEnabled = document.getElementById('auto-refresh').checked;

            if (autoRefreshEnabled) {
                startAutoRefresh();
                log('info', 'Auto refresh enabled');
            } else {
                stopAutoRefresh();
                log('info', 'Auto refresh disabled');
            }
        };

        // Start auto refresh
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            if (autoRefreshEnabled) {
                autoRefreshInterval = setInterval(async () => {
                    await refreshBuffs();
                    if (currentTab === 'items') {
                        await refreshItems();
                    } else if (currentTab === 'pets') {
                        await refreshPets();
                    }
                    await refreshProfile();
                }, 10000); // Refresh every 10 seconds
            }
        }

        // Stop auto refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Logging function
        function log(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">[${timestamp}]</span>
                <span class="log-level-${level}">${message}</span>
            `;

            const logsContainer = document.getElementById('logs-container');
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            console.log(`[${timestamp}] ${level.toUpperCase()}: ${message}`);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
