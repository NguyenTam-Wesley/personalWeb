<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sudoku Best Time Display</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .result { margin: 10px 0; padding: 10px; background: #f9f9f9; }
        .error { background: #ffe6e6; color: #cc0000; }
        .success { background: #e6ffe6; color: #009900; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .best-time-display { font-weight: bold; color: #007bff; }
        .rank-display { font-weight: bold; color: #28a745; }
    </style>
</head>
<body>
    <h1>Test Sudoku Best Time Display</h1>

    <div class="test-section">
        <h3>1. Test Best Time Display Element</h3>
        <div id="best-time-display" class="best-time-display">Best: --:--</div>
        <button onclick="testElementBinding()">Test Element Binding</button>
        <div id="element-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. Test Rank Display Element</h3>
        <div id="rank-display" class="rank-display">Rank: --</div>
        <button onclick="testRankElementBinding()">Test Rank Element Binding</button>
        <div id="rank-element-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. Test Database Query</h3>
        <div style="margin-bottom: 10px;">
            <label>Difficulty: </label>
            <select id="test-difficulty">
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
                <option value="very_hard">Very Hard</option>
                <option value="expert">Expert</option>
            </select>
        </div>
        <button onclick="testDatabaseQuery()">Test Database Query</button>
        <div id="db-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. Test Full Update Functions</h3>
        <button onclick="testUpdateFunctions()">Test Update Functions</button>
        <div id="update-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>5. Test Game Config Loading</h3>
        <button onclick="testGameConfig()">Test Game Config</button>
        <div id="config-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>6. Manual Test - Simulate Sudoku Game</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="number" id="test-time" placeholder="Time in seconds (e.g. 300)" value="300">
            <select id="simulate-difficulty">
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
                <option value="very_hard">Very Hard</option>
                <option value="expert">Expert</option>
            </select>
            <button onclick="simulateGameResult()">Simulate Game Result</button>
        </div>
        <div id="simulate-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>7. Test Realtime UI Updates</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="number" id="realtime-time" placeholder="Time in seconds (e.g. 250)" value="250">
            <select id="realtime-difficulty">
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
                <option value="very_hard">Very Hard</option>
                <option value="expert">Expert</option>
            </select>
            <button onclick="testRealtimeUpdate()">Test Realtime Update</button>
        </div>
        <div id="realtime-result" class="result"></div>
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
            Note: This simulates the UI update that happens after game submission.
            Check if Best Time and Rank update without page refresh.
        </div>
    </div>

    <script type="module">
        import { supabase } from './public/js/supabase/supabase.js';

        // Test best time element binding
        window.testElementBinding = function() {
            const element = document.getElementById('best-time-display');
            const resultDiv = document.getElementById('element-result');

            if (element) {
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Element found: ${element.tagName}#${element.id} with content: "${element.textContent}"`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Element not found!';
            }
        };

        // Test rank element binding
        window.testRankElementBinding = function() {
            const element = document.getElementById('rank-display');
            const resultDiv = document.getElementById('rank-element-result');

            if (element) {
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Rank element found: ${element.tagName}#${element.id} with content: "${element.textContent}"`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Rank element not found!';
            }
        };

        // Test database query directly
        window.testDatabaseQuery = async function() {
            const resultDiv = document.getElementById('db-result');
            const difficulty = document.getElementById('test-difficulty').value;

            try {
                // Get current user
                const { data: userData, error: userError } = await supabase.auth.getUser();
                if (userError || !userData.user) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå User not logged in';
                    return;
                }

                // Get game config
                const { data: gameData, error: gameError } = await supabase
                    .from('games')
                    .select('id')
                    .eq('code', 'sudoku')
                    .maybeSingle();

                if (gameError || !gameData) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå Game not found: ' + (gameError?.message || 'No data');
                    return;
                }

                const { data: modeData, error: modeError } = await supabase
                    .from('game_modes')
                    .select('id')
                    .eq('game_id', gameData.id)
                    .eq('code', difficulty)
                    .maybeSingle();

                if (modeError || !modeData) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå Game mode not found: ' + (modeError?.message || 'No data');
                    return;
                }

                // Query best time
                const { data: bestTime, error: timeError } = await supabase
                    .from('game_best_scores')
                    .select('metric_value, better_is, updated_at')
                    .eq('user_id', userData.user.id)
                    .eq('game_id', gameData.id)
                    .eq('mode_id', modeData.id)
                    .maybeSingle();

                if (timeError) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Query error: ${timeError.message}`;
                    return;
                }

                const formatTime = (seconds) => {
                    if (!seconds) return '--:--';
                    const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
                    const secs = String(seconds % 60).padStart(2, '0');
                    return `${mins}:${secs}`;
                };

                if (bestTime) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ Best time found for ${difficulty}:<br>
                        - Time: ${formatTime(bestTime.metric_value)}<br>
                        - Better is: ${bestTime.better_is}<br>
                        - Updated: ${new Date(bestTime.updated_at).toLocaleString()}
                    `;
                } else {
                    resultDiv.className = 'result';
                    resultDiv.textContent = `‚ÑπÔ∏è No best time found for ${difficulty} (this is normal for new users or first time playing)`;
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Unexpected error: ${error.message}`;
            }
        };

        // Test the actual update functions from sudoku.js
        window.testUpdateFunctions = async function() {
            const resultDiv = document.getElementById('update-result');

            try {
                // Import the SudokuGame class
                const { SudokuGame } = await import('./public/js/modules/sudoku.js');

                // Create instance
                const game = new SudokuGame();

                // Wait for DOM to be ready
                await new Promise(resolve => setTimeout(resolve, 100));

                // Call update functions
                await game.updateBestTimeDisplay();
                await game.updateRankDisplay();

                const bestTimeElement = document.getElementById('best-time-display');
                const rankElement = document.getElementById('rank-display');

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    ‚úÖ Update functions called successfully!<br>
                    - Best Time: "${bestTimeElement.textContent}"<br>
                    - Rank: "${rankElement.textContent}"
                `;

                // Clean up - remove event listeners
                if (game.grid) {
                    // We don't have a destroy method for sudoku, just note it
                    console.log('Note: Sudoku game instance created for testing');
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Update functions error: ${error.message}`;
            }
        };

        // Test game config loading
        window.testGameConfig = async function() {
            const resultDiv = document.getElementById('config-result');

            try {
                // Get game ID
                const { data: gameData, error: gameError } = await supabase
                    .from('games')
                    .select('id, code, name')
                    .eq('code', 'sudoku')
                    .maybeSingle();

                if (gameError || !gameData) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå Game lookup failed: ' + (gameError?.message || 'No data');
                    return;
                }

                // Get all modes for sudoku
                const { data: modesData, error: modesError } = await supabase
                    .from('game_modes')
                    .select('id, code, name')
                    .eq('game_id', gameData.id);

                if (modesError) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå Modes lookup failed: ' + modesError.message;
                    return;
                }

                resultDiv.className = 'result success';
                let html = `
                    ‚úÖ Sudoku game config loaded:<br>
                    - Game: ${gameData.name} (${gameData.code}) - ID: ${gameData.id}<br>
                    - Available modes:<br>
                `;

                modesData.forEach(mode => {
                    html += `&nbsp;&nbsp;&nbsp;- ${mode.name} (${mode.code}) - ID: ${mode.id}<br>`;
                });

                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Config loading error: ${error.message}`;
            }
        };

        // Simulate submitting a sudoku game result
        window.simulateGameResult = async function() {
            const resultDiv = document.getElementById('simulate-result');
            const timeInput = document.getElementById('test-time');
            const difficulty = document.getElementById('simulate-difficulty').value;
            const testTime = parseInt(timeInput.value) || 300;

            try {
                const { data: userData, error: userError } = await supabase.auth.getUser();
                if (userError || !userData.user) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå User not logged in';
                    return;
                }

                // Submit a fake sudoku game result
                const submitResult = await supabase.functions.invoke('submitGameResult', {
                    body: {
                        game_code: 'sudoku',
                        mode_code: difficulty,
                        metric_type: 'time',
                        metric_value: testTime,
                        extra_data: {
                            mistakes: 0,
                            completed: true,
                            difficulty: difficulty
                        }
                    }
                });

                if (submitResult.error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Submit failed: ${submitResult.error.message}`;
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ Sudoku game result submitted successfully!<br>
                        - Difficulty: ${difficulty}<br>
                        - Time: ${Math.floor(testTime / 60)}:${String(testTime % 60).padStart(2, '0')}<br>
                        <button onclick="testDatabaseQuery()">Check if best time updated</button>
                    `;
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Simulation error: ${error.message}`;
            }
        };

        // Test realtime UI updates
        window.testRealtimeUpdate = async function() {
            const resultDiv = document.getElementById('realtime-result');
            const timeInput = document.getElementById('realtime-time');
            const difficulty = document.getElementById('realtime-difficulty').value;
            const testTime = parseInt(timeInput.value) || 250;

            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div>‚è≥ Testing realtime UI update...</div>';

            try {
                // First, submit a fake game result to update database
                const { data: userData, error: userError } = await supabase.auth.getUser();
                if (userError || !userData.user) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå User not logged in for realtime test';
                    return;
                }

                // Submit test result
                const submitResult = await supabase.functions.invoke('submitGameResult', {
                    body: {
                        game_code: 'sudoku',
                        mode_code: difficulty,
                        metric_type: 'time',
                        metric_value: testTime,
                        extra_data: {
                            mistakes: 0,
                            completed: true,
                            difficulty: difficulty
                        }
                    }
                });

                if (submitResult.error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Submit failed: ${submitResult.error.message}`;
                    return;
                }

                // Wait a moment for database update
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Test UI updates (simulate what happens in checkSolution)
                const bestTimeElement = document.getElementById('best-time-display');
                const rankElement = document.getElementById('rank-display');
                const initialBestTime = bestTimeElement.textContent;
                const initialRank = rankElement.textContent;

                // Simulate realtime update calls
                try {
                    // Load SudokuGame class to test update methods
                    const { SudokuGame } = await import('./public/js/modules/sudoku.js');
                    const game = new SudokuGame();

                    // Set difficulty to match the test
                    game.difficulty = difficulty;

                    // Call update methods
                    await game.updateBestTimeDisplay();
                    await game.updateRankDisplay();

                    const finalBestTime = bestTimeElement.textContent;
                    const finalRank = rankElement.textContent;

                    const timeChanged = initialBestTime !== finalBestTime;
                    const rankChanged = initialRank !== finalRank;

                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ Realtime UI update test completed!<br>
                        - Submitted time: ${Math.floor(testTime / 60)}:${String(testTime % 60).padStart(2, '0')} for ${difficulty}<br>
                        - Best Time: "${initialBestTime}" ‚Üí "${finalBestTime}"<br>
                        - Rank: "${initialRank}" ‚Üí "${finalRank}"<br>
                        <strong>
                            ${timeChanged || rankChanged ?
                                'üéâ UI UPDATED SUCCESSFULLY!' :
                                '‚ÑπÔ∏è No change (time may not be better)'}
                        </strong>
                    `;

                } catch (uiError) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå UI update test failed: ${uiError.message}`;
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Realtime test error: ${error.message}`;
            }
        };

        // Run initial tests
        setTimeout(() => {
            testElementBinding();
            testRankElementBinding();
        }, 100);
    </script>
</body>
</html>
