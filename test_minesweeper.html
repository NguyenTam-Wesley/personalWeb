<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Minesweeper</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .test-result { padding: 10px; margin: 5px 0; }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        button { padding: 10px 15px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Minesweeper Logic Test</h1>

    <div class="test-section">
        <h2>Test Worker Creation</h2>
        <button onclick="testWorkerCreation()">Test Worker Creation</button>
        <div id="worker-test" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>Test Board Initialization</h2>
        <button onclick="testBoardInit()">Test Board Init (Easy)</button>
        <div id="board-test" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>Test Cell Opening</h2>
        <button onclick="testCellOpening()">Test Cell Opening</button>
        <div id="cell-test" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>Test Flood Fill</h2>
        <button onclick="testFloodFill()">Test Flood Fill</button>
        <div id="flood-test" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>Test Win Condition</h2>
        <button onclick="testWinCondition()">Test Win Condition</button>
        <div id="win-test" class="test-result"></div>
    </div>

    <script>
        let testWorker = null;

        function testWorkerCreation() {
            const resultEl = document.getElementById('worker-test');
            try {
                testWorker = new Worker('public/js/workers/minesweeper.worker.js');
                testWorker.onmessage = (e) => {
                    if (e.data.type === 'ready') {
                        resultEl.className = 'test-result pass';
                        resultEl.textContent = '✓ Worker created and initialized successfully';
                    }
                };
                testWorker.postMessage({ type: 'init', data: { rows: 9, cols: 9, mines: 10 } });
            } catch (error) {
                resultEl.className = 'test-result fail';
                resultEl.textContent = '✗ Worker creation failed: ' + error.message;
            }
        }

        function testBoardInit() {
            const resultEl = document.getElementById('board-test');
            if (!testWorker) {
                resultEl.className = 'test-result fail';
                resultEl.textContent = '✗ Worker not initialized';
                return;
            }

            testWorker.onmessage = (e) => {
                if (e.data.type === 'ready') {
                    resultEl.className = 'test-result pass';
                    resultEl.textContent = `✓ Board initialized: ${e.data.config.rows}x${e.data.config.cols} with ${e.data.config.mines} mines`;
                }
            };
            testWorker.postMessage({ type: 'init', data: { rows: 9, cols: 9, mines: 10 } });
        }

        function testCellOpening() {
            const resultEl = document.getElementById('cell-test');
            if (!testWorker) {
                resultEl.className = 'test-result fail';
                resultEl.textContent = '✗ Worker not initialized';
                return;
            }

            let messageCount = 0;
            testWorker.onmessage = (e) => {
                if (e.data.type === 'ready' && messageCount === 0) {
                    messageCount++;
                    // Now test cell opening
                    testWorker.postMessage({ type: 'openCell', data: { x: 0, y: 0 } });
                } else if (e.data.type === 'update' && messageCount === 1) {
                    messageCount++;
                    if (e.data.revealed && e.data.revealed.length > 0) {
                        resultEl.className = 'test-result pass';
                        resultEl.textContent = `✓ Cell opening works: revealed ${e.data.revealed.length} cells`;
                    } else {
                        resultEl.className = 'test-result fail';
                        resultEl.textContent = '✗ Cell opening failed: no cells revealed';
                    }
                }
            };

            // First init the board
            testWorker.postMessage({ type: 'init', data: { rows: 9, cols: 9, mines: 10 } });
        }

        function testFloodFill() {
            const resultEl = document.getElementById('flood-test');
            if (!testWorker) {
                resultEl.className = 'test-result fail';
                resultEl.textContent = '✗ Worker not initialized';
                return;
            }

            let messageCount = 0;
            testWorker.onmessage = (e) => {
                if (e.data.type === 'ready' && messageCount === 0) {
                    messageCount++;
                    // Open a corner cell which should trigger flood fill
                    testWorker.postMessage({ type: 'openCell', data: { x: 0, y: 0 } });
                } else if (e.data.type === 'update' && messageCount === 1) {
                    messageCount++;
                    const revealedCount = e.data.revealed ? e.data.revealed.length : 0;
                    if (revealedCount > 1) {
                        resultEl.className = 'test-result pass';
                        resultEl.textContent = `✓ Flood fill works: revealed ${revealedCount} cells from corner`;
                    } else {
                        resultEl.className = 'test-result fail';
                        resultEl.textContent = `✗ Flood fill failed: only ${revealedCount} cells revealed`;
                    }
                }
            };

            // Init with easy board
            testWorker.postMessage({ type: 'init', data: { rows: 9, cols: 9, mines: 10 } });
        }

        function testWinCondition() {
            const resultEl = document.getElementById('win-test');
            resultEl.className = 'test-result';
            resultEl.textContent = 'Testing win condition...';

            if (!testWorker) {
                resultEl.className = 'test-result fail';
                resultEl.textContent = '✗ Worker not initialized';
                return;
            }

            // For a proper win test, we'd need to reveal all non-mine cells
            // This is a simplified test
            testWorker.onmessage = (e) => {
                if (e.data.type === 'win') {
                    if (e.data.won) {
                        resultEl.className = 'test-result pass';
                        resultEl.textContent = '✓ Win condition check works';
                    } else {
                        resultEl.className = 'test-result fail';
                        resultEl.textContent = '✗ Win condition check failed';
                    }
                }
            };

            testWorker.postMessage({ type: 'checkWin' });
        }
    </script>
</body>
</html>