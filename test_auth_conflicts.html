<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auth Conflicts - Multiple Tabs</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .result { margin: 10px 0; padding: 10px; background: #f9f9f9; }
        .error { background: #ffe6e6; color: #cc0000; }
        .success { background: #e6ffe6; color: #009900; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .auth-status { font-weight: bold; padding: 10px; background: #e9ecef; margin: 10px 0; }
        .tab-info { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>Test Auth Conflicts - Multiple Tabs</h1>

    <div class="tab-info">
        <strong>Tab ID:</strong> <span id="tab-id">Loading...</span><br>
        <strong>Auth Status:</strong> <span id="auth-status">Checking...</span><br>
        <strong>User ID:</strong> <span id="user-id">Unknown</span>
    </div>

    <div class="test-section">
        <h3>1. Check Current Auth State</h3>
        <button onclick="checkAuthState()">Check Auth State</button>
        <div id="auth-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. Test Auth Events</h3>
        <button onclick="testAuthEvents()">Test Auth Events</button>
        <div id="events-result" class="result"></div>
        <div id="events-log" style="margin-top: 10px; font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 10px; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <div class="test-section">
        <h3>3. Simulate Multiple Tabs Scenario</h3>
        <p>This test simulates what happens when you have multiple game tabs open.</p>
        <button onclick="simulateMultipleTabs()">Simulate Multiple Tabs</button>
        <div id="multi-tab-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. Force Logout Test</h3>
        <button onclick="forceLogout()">Force Logout</button>
        <div id="logout-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>5. How to Test Real Scenario</h3>
        <ol>
            <li>Open this page in Tab 1</li>
            <li>Login if not already logged in</li>
            <li>Open a new tab (Tab 2) with 2048 game: <code>/pages/games/2048/2048.html</code></li>
            <li>Open another tab (Tab 3) with Sudoku game: <code>/pages/games/sudoku.html</code></li>
            <li>Switch between tabs - you should stay logged in</li>
            <li>Play games and submit results - auth should persist</li>
        </ol>
        <div class="warning" style="margin-top: 10px;">
            <strong>Expected Result:</strong> No automatic logout when switching between multiple game tabs.
        </div>
    </div>

    <script type="module">
        import { supabase } from './public/js/supabase/supabase.js';

        // Generate unique tab ID
        const tabId = 'tab_' + Math.random().toString(36).substr(2, 9);
        document.getElementById('tab-id').textContent = tabId;

        let eventLog = [];

        // Log auth events
        function logEvent(event, data) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${event}: ${JSON.stringify(data)}`;
            eventLog.push(logEntry);

            // Keep only last 10 entries
            if (eventLog.length > 10) {
                eventLog = eventLog.slice(-10);
            }

            document.getElementById('events-log').innerHTML = eventLog.join('<br>');
        }

        // Listen to auth events
        window.addEventListener('authStateChanged', (e) => {
            const { event, session } = e.detail;
            logEvent(`Auth Event (${tabId})`, { event, hasSession: !!session });

            updateAuthStatus();
        });

        // Initial auth check
        async function updateAuthStatus() {
            try {
                const { data: session } = await supabase.auth.getSession();
                const authStatus = document.getElementById('auth-status');
                const userId = document.getElementById('user-id');

                if (session?.session) {
                    authStatus.textContent = '‚úÖ Logged In';
                    authStatus.style.color = 'green';
                    userId.textContent = session.session.user.id;
                } else {
                    authStatus.textContent = '‚ùå Not Logged In';
                    authStatus.style.color = 'red';
                    userId.textContent = 'None';
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
            }
        }

        // Check auth state
        window.checkAuthState = async function() {
            const resultDiv = document.getElementById('auth-result');

            try {
                const { data: session, error } = await supabase.auth.getSession();

                if (error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Auth error: ${error.message}`;
                    return;
                }

                if (session?.session) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ Authenticated<br>
                        - User ID: ${session.session.user.id}<br>
                        - Email: ${session.session.user.email}<br>
                        - Expires: ${new Date(session.session.expires_at * 1000).toLocaleString()}
                    `;
                } else {
                    resultDiv.className = 'result warning';
                    resultDiv.textContent = '‚ö†Ô∏è Not authenticated - please login first';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Unexpected error: ${error.message}`;
            }
        };

        // Test auth events
        window.testAuthEvents = function() {
            const resultDiv = document.getElementById('events-result');

            resultDiv.className = 'result success';
            resultDiv.innerHTML = `
                ‚úÖ Auth event listener active<br>
                üìã Check the events log above to see auth state changes<br>
                üîÑ Events are broadcasted globally to all tabs
            `;

            logEvent('Test Event', { tabId, message: 'Auth events are working' });
        };

        // Simulate multiple tabs scenario
        window.simulateMultipleTabs = function() {
            const resultDiv = document.getElementById('multi-tab-result');

            resultDiv.className = 'result';
            resultDiv.innerHTML = `
                üîÑ Simulating multiple tabs scenario...<br>
                üìã This simulates what happens when you open multiple game tabs<br><br>
                <strong>Before Fix:</strong> Multiple auth listeners would conflict ‚Üí automatic logout<br>
                <strong>After Fix:</strong> Single global auth listener ‚Üí no conflicts<br><br>
                ‚úÖ Custom events are broadcasted to all tabs<br>
                ‚úÖ No auth listener conflicts<br>
                ‚úÖ Session persists across tabs
            `;

            // Simulate auth event broadcast
            setTimeout(() => {
                window.dispatchEvent(new CustomEvent('authStateChanged', {
                    detail: { event: 'SIMULATED_TEST', session: { test: true } }
                }));
            }, 1000);
        };

        // Force logout test
        window.forceLogout = async function() {
            const resultDiv = document.getElementById('logout-result');

            try {
                const { error } = await supabase.auth.signOut();

                if (error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Logout failed: ${error.message}`;
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '‚úÖ Successfully logged out';
                    logEvent('Manual Logout', { tabId });
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Unexpected error: ${error.message}`;
            }
        };

        // Initialize
        setTimeout(() => {
            updateAuthStatus();
            logEvent('Page Load', { tabId, url: window.location.href });
        }, 100);
    </script>
</body>
</html>
